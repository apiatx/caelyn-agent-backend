Here's the prompt for Replit Agent:

Please make the following changes to my backend project. Do not delete or modify any existing code unless I specifically say "replace."
First, install the Finnhub package by running this in the Shell:
bashpip install finnhub-python
Then, add a new secret in the Secrets panel (lock icon):

Key: FINNHUB_API_KEY
Value: (get your free API key from https://finnhub.io — sign up and it's on the dashboard)

1. In config.py, add this line after the existing lines:
pythonFINNHUB_API_KEY = os.getenv("FINNHUB_API_KEY")
2. Create a new file data/finnhub_provider.py with this code:
pythonimport finnhub
from datetime import datetime, timedelta


class FinnhubProvider:
    """
    Provides insider trading data, earnings calendar, earnings surprises,
    social sentiment, company peers, and recommendation trends via
    Finnhub's free API.
    """

    def __init__(self, api_key: str):
        self.client = finnhub.Client(api_key=api_key)

    def get_insider_sentiment(self, ticker: str) -> dict:
        """
        Get insider sentiment (MSPR) for a ticker.
        MSPR ranges from -100 (heavy insider selling) to +100 (heavy insider buying).
        This can signal price changes 30-90 days out.
        """
        ticker = ticker.upper()
        try:
            today = datetime.now()
            one_year_ago = today - timedelta(days=365)
            data = self.client.stock_insider_sentiment(
                ticker,
                one_year_ago.strftime("%Y-%m-%d"),
                today.strftime("%Y-%m-%d"),
            )
            records = data.get("data", [])
            if not records:
                return {"ticker": ticker, "insider_sentiment": None}

            # Get the most recent months
            recent = records[-3:] if len(records) >= 3 else records
            latest = records[-1]

            return {
                "ticker": ticker,
                "latest_mspr": latest.get("mspr"),
                "latest_change": latest.get("change"),
                "latest_month": f"{latest.get('year')}-{latest.get('month')}",
                "trend": [
                    {
                        "month": f"{r.get('year')}-{r.get('month')}",
                        "mspr": r.get("mspr"),
                        "share_change": r.get("change"),
                    }
                    for r in recent
                ],
                "signal": self._interpret_mspr(latest.get("mspr")),
            }
        except Exception as e:
            print(f"Finnhub insider sentiment error for {ticker}: {e}")
            return {"ticker": ticker, "insider_sentiment": None, "error": str(e)}

    def get_insider_transactions(self, ticker: str) -> list:
        """Get recent insider buy/sell transactions (SEC Form 4 filings)."""
        ticker = ticker.upper()
        try:
            data = self.client.stock_insider_transactions(ticker)
            transactions = data.get("data", [])[:10]
            return [
                {
                    "name": t.get("name"),
                    "share": t.get("share"),
                    "change": t.get("change"),
                    "transaction_type": t.get("transactionType"),
                    "transaction_date": t.get("transactionDate"),
                    "filing_date": t.get("filingDate"),
                }
                for t in transactions
            ]
        except Exception as e:
            print(f"Finnhub insider transactions error for {ticker}: {e}")
            return []

    def get_earnings_calendar(self, ticker: str = None) -> list:
        """
        Get upcoming earnings dates. If ticker is provided, get earnings
        for that specific stock. Otherwise get the market-wide calendar.
        """
        try:
            today = datetime.now()
            next_month = today + timedelta(days=30)
            data = self.client.earnings_calendar(
                _from=today.strftime("%Y-%m-%d"),
                to=next_month.strftime("%Y-%m-%d"),
                symbol=ticker.upper() if ticker else None,
            )
            earnings = data.get("earningsCalendar", [])

            if ticker:
                # Filter for the specific ticker
                earnings = [
                    e for e in earnings
                    if e.get("symbol", "").upper() == ticker.upper()
                ]

            results = []
            for e in earnings[:20]:
                results.append({
                    "ticker": e.get("symbol"),
                    "date": e.get("date"),
                    "eps_estimate": e.get("epsEstimate"),
                    "revenue_estimate": e.get("revenueEstimate"),
                    "hour": e.get("hour"),
                    "quarter": e.get("quarter"),
                    "year": e.get("year"),
                })
            return results
        except Exception as e:
            print(f"Finnhub earnings calendar error: {e}")
            return []

    def get_earnings_surprises(self, ticker: str) -> list:
        """Get past earnings results vs estimates (beat or miss)."""
        ticker = ticker.upper()
        try:
            data = self.client.company_earnings(ticker, limit=4)
            return [
                {
                    "period": e.get("period"),
                    "actual_eps": e.get("actual"),
                    "estimate_eps": e.get("estimate"),
                    "surprise": e.get("surprise"),
                    "surprise_percent": e.get("surprisePercent"),
                    "beat": e.get("actual", 0) > e.get("estimate", 0)
                    if e.get("actual") is not None and e.get("estimate") is not None
                    else None,
                }
                for e in data
            ]
        except Exception as e:
            print(f"Finnhub earnings surprises error for {ticker}: {e}")
            return []

    def get_recommendation_trends(self, ticker: str) -> list:
        """Get analyst recommendation trends (buy/hold/sell counts over time)."""
        ticker = ticker.upper()
        try:
            data = self.client.recommendation_trends(ticker)
            return [
                {
                    "period": r.get("period"),
                    "strong_buy": r.get("strongBuy"),
                    "buy": r.get("buy"),
                    "hold": r.get("hold"),
                    "sell": r.get("sell"),
                    "strong_sell": r.get("strongSell"),
                }
                for r in data[:4]
            ]
        except Exception as e:
            print(f"Finnhub recommendation trends error for {ticker}: {e}")
            return []

    def get_social_sentiment(self, ticker: str) -> dict:
        """Get social media sentiment from Reddit and Twitter."""
        ticker = ticker.upper()
        try:
            data = self.client.stock_social_sentiment(ticker)
            reddit_data = data.get("reddit", [])
            twitter_data = data.get("twitter", [])

            reddit_summary = None
            if reddit_data:
                recent_reddit = reddit_data[-5:] if len(reddit_data) >= 5 else reddit_data
                total_mentions = sum(r.get("mention", 0) for r in recent_reddit)
                avg_score = (
                    sum(r.get("score", 0) for r in recent_reddit) / len(recent_reddit)
                    if recent_reddit
                    else 0
                )
                positive = sum(
                    r.get("positiveScore", 0) for r in recent_reddit
                )
                negative = sum(
                    r.get("negativeScore", 0) for r in recent_reddit
                )
                reddit_summary = {
                    "total_mentions": total_mentions,
                    "avg_score": round(avg_score, 2),
                    "positive_score": round(positive, 2),
                    "negative_score": round(negative, 2),
                    "sentiment": "bullish" if positive > negative else "bearish"
                    if negative > positive
                    else "neutral",
                }

            twitter_summary = None
            if twitter_data:
                recent_twitter = twitter_data[-5:] if len(twitter_data) >= 5 else twitter_data
                total_mentions = sum(t.get("mention", 0) for t in recent_twitter)
                avg_score = (
                    sum(t.get("score", 0) for t in recent_twitter)
                    / len(recent_twitter)
                    if recent_twitter
                    else 0
                )
                positive = sum(
                    t.get("positiveScore", 0) for t in recent_twitter
                )
                negative = sum(
                    t.get("negativeScore", 0) for t in recent_twitter
                )
                twitter_summary = {
                    "total_mentions": total_mentions,
                    "avg_score": round(avg_score, 2),
                    "positive_score": round(positive, 2),
                    "negative_score": round(negative, 2),
                    "sentiment": "bullish" if positive > negative else "bearish"
                    if negative > positive
                    else "neutral",
                }

            return {
                "ticker": ticker,
                "reddit": reddit_summary,
                "twitter": twitter_summary,
            }
        except Exception as e:
            print(f"Finnhub social sentiment error for {ticker}: {e}")
            return {"ticker": ticker, "reddit": None, "twitter": None}

    def get_company_peers(self, ticker: str) -> list:
        """Get list of peer/comparable companies."""
        ticker = ticker.upper()
        try:
            return self.client.company_peers(ticker)
        except Exception as e:
            print(f"Finnhub peers error for {ticker}: {e}")
            return []

    def get_upcoming_earnings(self) -> list:
        """Get all earnings coming up in the next 7 days."""
        try:
            today = datetime.now()
            next_week = today + timedelta(days=7)
            data = self.client.earnings_calendar(
                _from=today.strftime("%Y-%m-%d"),
                to=next_week.strftime("%Y-%m-%d"),
                symbol=None,
            )
            earnings = data.get("earningsCalendar", [])
            return [
                {
                    "ticker": e.get("symbol"),
                    "date": e.get("date"),
                    "eps_estimate": e.get("epsEstimate"),
                    "revenue_estimate": e.get("revenueEstimate"),
                    "hour": e.get("hour"),
                }
                for e in earnings[:30]
            ]
        except Exception as e:
            print(f"Finnhub upcoming earnings error: {e}")
            return []

    def _interpret_mspr(self, mspr) -> str:
        """Interpret the insider sentiment MSPR score."""
        if mspr is None:
            return "no data"
        if mspr > 50:
            return "strong insider buying — very bullish signal"
        if mspr > 20:
            return "moderate insider buying — bullish signal"
        if mspr > 0:
            return "slight insider buying — mildly bullish"
        if mspr > -20:
            return "slight insider selling — mildly bearish"
        if mspr > -50:
            return "moderate insider selling — bearish signal"
        return "heavy insider selling — very bearish signal"
3. In config.py, the file should now look like this (add the Finnhub line if not already there):
pythonimport os

ANTHROPIC_API_KEY = os.getenv("ANTHROPIC_API_KEY")
POLYGON_API_KEY = os.getenv("POLYGON_API_KEY")
FINNHUB_API_KEY = os.getenv("FINNHUB_API_KEY")
4. In data/market_data_service.py, make these changes:

Add these imports after the existing imports at the top:

pythonfrom data.finnhub_provider import FinnhubProvider
from config import FINNHUB_API_KEY

In the __init__ method, add this line after the other self. assignments:

python        self.finnhub = FinnhubProvider(FINNHUB_API_KEY)

Replace the research_ticker method with this:

python    async def research_ticker(self, ticker: str) -> dict:
        """
        Get everything about a single stock.
        Used when someone asks "analyze NVDA" or "what's happening with AAPL".
        """
        ticker = ticker.upper()
        return {
            "snapshot": self.polygon.get_snapshot(ticker),
            "technicals": self.polygon.get_technicals(ticker),
            "details": self.polygon.get_ticker_details(ticker),
            "news": self.polygon.get_news(ticker, limit=10),
            "sentiment": await self.stocktwits.get_sentiment(ticker),
            "fundamentals": await self.stockanalysis.get_overview(ticker),
            "financials": await self.stockanalysis.get_financials(ticker),
            "analyst_ratings": await self.stockanalysis.get_analyst_ratings(ticker),
            "options_put_call": await self.options.get_put_call_ratio(ticker),
            "insider_sentiment": self.finnhub.get_insider_sentiment(ticker),
            "insider_transactions": self.finnhub.get_insider_transactions(ticker),
            "earnings_history": self.finnhub.get_earnings_surprises(ticker),
            "earnings_upcoming": self.finnhub.get_earnings_calendar(ticker),
            "recommendation_trends": self.finnhub.get_recommendation_trends(ticker),
            "social_sentiment": self.finnhub.get_social_sentiment(ticker),
            "peer_companies": self.finnhub.get_company_peers(ticker),
        }

Replace the scan_market method with this:

python    async def scan_market(self) -> dict:
        """Broad market overview with all data sources."""
        movers = self.polygon.get_market_movers()

        top_gainer_tickers = [
            g["ticker"] for g in movers.get("gainers", [])[:5]
        ]

        catalyst_data = {}
        for ticker in top_gainer_tickers:
            catalyst_data[ticker] = {
                "details": self.polygon.get_ticker_details(ticker),
                "technicals": self.polygon.get_technicals(ticker),
                "news": self.polygon.get_ticker_events(ticker)["news"],
                "sentiment": await self.stocktwits.get_sentiment(ticker),
                "fundamentals": await self.stockanalysis.get_overview(ticker),
                "analyst_ratings": await self.stockanalysis.get_analyst_ratings(ticker),
                "insider_sentiment": self.finnhub.get_insider_sentiment(ticker),
                "earnings_upcoming": self.finnhub.get_earnings_calendar(ticker),
            }

        trending = await self.stocktwits.get_trending()

        # Options flow data
        unusual_options = await self.options.get_unusual_options_activity()
        options_signals = self.options.interpret_flow(unusual_options)
        options_volume_leaders = await self.options.get_options_volume_leaders()

        # Upcoming earnings this week
        upcoming_earnings = self.finnhub.get_upcoming_earnings()

        return {
            "movers": movers,
            "market_news": self.polygon.get_news(limit=15),
            "screener_gainers": await self.finviz.get_screener_results(
                "ta_topgainers"
            ),
            "catalyst_data": catalyst_data,
            "stocktwits_trending": trending,
            "unusual_options_activity": unusual_options,
            "options_flow_signals": options_signals,
            "options_volume_leaders": options_volume_leaders,
            "upcoming_earnings_this_week": upcoming_earnings,
        }

Add a new method to the class:

python    async def get_earnings_scan(self) -> dict:
        """
        Dedicated earnings scan.
        Used for "what earnings are coming up" type queries.
        """
        return {
            "upcoming_earnings": self.finnhub.get_upcoming_earnings(),
        }
5. In agent/claude_agent.py, add earnings routing.
Find the _gather_data method. Find the line that says:
python        elif category == "options_flow":
            return await self.data.get_options_flow()
Add this block right AFTER it:
python        elif category == "earnings":
            return await self.data.get_earnings_scan()
```

**6. In `agent/prompts.py`, make two changes:**

First, in the `QUERY_CLASSIFIER_PROMPT`, find the list of categories and add this line after the `"options_flow"` line:
```
- "earnings": User asks about upcoming earnings, earnings calendar, earnings reports, or which companies are reporting soon.
```

Second, in the `SYSTEM_PROMPT`, add these lines after the existing options flow instructions:
```
- Insider Trading (use Finnhub insider sentiment and transactions to gauge whether company executives are buying or selling)
- An MSPR score above 20 means insiders are net buying — this is a bullish signal. Below -20 means net selling — bearish signal.
- When insiders are heavily buying their own stock while the stock is also showing strong technicals, flag this as a very high-conviction setup
- When insiders are selling while retail sentiment is bullish, warn about potential divergence
- Always check and mention upcoming earnings dates — earnings are the single biggest catalyst for stock moves
- When a stock has earnings coming up within 7 days, flag this as a key risk/opportunity event
- Use earnings surprise history (beat/miss track record) to assess the probability of another beat
- If a company has beaten estimates for 3+ consecutive quarters, mention this streak
- Use social sentiment from Reddit and Twitter to gauge retail trader interest and positioning
- When social sentiment diverges from insider sentiment (e.g., Reddit bullish but insiders selling), highlight this as a warning signal
- Mention peer companies when analyzing a stock so the user knows related names to watch
- Use analyst recommendation trends to show if Wall Street is getting more bullish or bearish over recent months
7. Re-publish/deploy the project when done.
