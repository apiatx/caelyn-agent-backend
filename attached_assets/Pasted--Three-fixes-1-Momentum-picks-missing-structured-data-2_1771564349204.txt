## Three fixes: (1) Momentum picks missing structured data, (2) X sentiment not displaying, (3) Reorder sections

### ROOT CAUSE for Fix 1
Claude receives the funding/7d data in the compressed payload (proven by funding divergences section showing OM at -0.29%, AXS at -0.18%), but when constructing the `top_momentum` JSON array, Claude puts the data in the `thesis` text but leaves the structured fields (price, change_7d, funding_rate, open_interest) as "N/A" or empty.

This is a PROMPT issue — Claude needs to be explicitly told to cross-reference the data sources when building momentum picks.

### Fix 1: Update Claude's crypto preamble with explicit field mapping

Find the crypto preamble/instructions in `claude_agent.py` (the text that gets prepended when category is "crypto"). Replace/update the momentum picks instructions:
```python
CRYPTO_MOMENTUM_MAPPING = """
CRITICAL — BUILDING top_momentum PICKS:
When you create each top_momentum entry, you MUST cross-reference ALL data sources to fill EVERY field:

For each momentum pick, look up the coin's data in this priority order:
1. top_coins[] — has price, change_24h, change_7d, change_30d, funding_rate, open_interest_usd (CoinGecko + HyperLiquid merged)
2. hl_additional_coins[] — has price_change_24h, funding_rate, funding_annualized, open_interest_usd (HyperLiquid only, for coins not in CoinGecko top 50)
3. perps_squeezes[] — has funding_rate, funding_annualized, open_interest_usd, price_change_24h
4. perps_divergences[] — has funding_rate, price_change_24h
5. perps_top_oi[] — has open_interest_usd, volume_24h_usd
6. funding_lookup from perps_crowded_longs[] and perps_top_volume[]

FIELD MAPPING RULES (never output N/A or "-" if data exists ANYWHERE in the payload):
- "price": Use top_coins[].price. If not in top_coins, check hl_additional_coins or omit (don't write "N/A")
- "change_24h": Use top_coins[].change_24h OR hl_additional_coins[].price_change_24h OR perps data
- "change_7d": Use top_coins[].change_7d. If coin is NOT in top_coins (e.g., OM, AXS), write the value from hl_additional_coins note or just omit the field
- "funding_rate": ALWAYS available from HyperLiquid. Check perps_squeezes, perps_divergences, perps_crowded_longs, hl_additional_coins, or top_coins. This should NEVER be "-" or empty.
- "open_interest": Check perps_top_oi, perps_squeezes, hl_additional_coins. Format as "$XXM" or "$X.XB"
- "market_cap": Use top_coins[].market_cap if available

EXAMPLE — if OM appears in perps_divergences with funding_rate: -0.0029 and price_change_24h: 22.93, and in perps_squeezes with open_interest_usd: 15000000:
{
    "coin": "OM",
    "symbol": "OM",
    "price": "",  ← omit if not in CoinGecko, don't write N/A
    "change_24h": "+22.93%",
    "change_7d": "",  ← omit if not available, don't write N/A
    "funding_rate": "-0.29%",  ← from divergences/squeezes data (raw * 100)
    "open_interest": "$15M",  ← from squeezes/OI data
    "conviction": "HIGH",
    "thesis": "..."
}

DO NOT put data in the thesis text while leaving the structured fields empty. The structured fields are what the UI renders.
"""
```

Add this to the crypto system prompt block in `_ask_claude()`.

### Fix 2: X Sentiment section not displaying

**Step A: Check if the Grok call is actually returning data**

Add logging in `get_crypto_scanner()` in `market_data_service.py`, after the gather results:
```python
    # After the gather, log what we got
    x_data = data.get("x_twitter_crypto", {})
    if isinstance(x_data, dict):
        if x_data.get("error"):
            print(f"[CRYPTO_SCANNER] X sentiment ERROR: {x_data.get('error')}")
        elif x_data.get("trending_tickers"):
            print(f"[CRYPTO_SCANNER] X sentiment: {len(x_data.get('trending_tickers', []))} trending tickers")
        else:
            print(f"[CRYPTO_SCANNER] X sentiment: empty/no tickers (keys: {list(x_data.keys())[:5]})")
    else:
        print(f"[CRYPTO_SCANNER] X sentiment: not a dict, type={type(x_data).__name__}")
```

**Step B: Check if compression preserves X data**

In the crypto compressor, add logging after the x_sentiment section:
```python
    # Log X sentiment compression result
    x_out = compressed.get("x_sentiment", {})
    if x_out:
        tickers_count = len(x_out.get("trending_tickers", []))
        print(f"[CRYPTO_COMPRESS] X sentiment preserved: {tickers_count} tickers, mood={x_out.get('market_mood')}")
    else:
        print(f"[CRYPTO_COMPRESS] X sentiment: EMPTY after compression")
```

**Step C: Make sure the x_sentiment key isn't being stripped by aggressive truncation**

The aggressive truncation in the compressor might be removing x_sentiment because it's one of the larger keys. In the crypto compressor, make sure x_sentiment is added BEFORE any size-based truncation, and that it's preserved.

Check if there's an `_aggressive_truncate` function that strips keys — if so, add "x_sentiment" to a "protected keys" list.

**Step D: Check if the Grok timeout is too short**

In `get_crypto_scanner()`, the Grok call might have a timeout that's too short. Find where x_twitter_crypto is called and make sure the timeout is at least 15 seconds:
```python
    if self.xai:
        tasks["x_twitter_crypto"] = asyncio.wait_for(
            self.xai.get_trending_tickers("crypto"), timeout=20.0  # Grok needs time to search X
        )
```

**Step E: Add x_sentiment to Claude's response schema explicitly**

In the crypto preamble, add:
X/TWITTER SENTIMENT SECTION:
You MUST include an "x_sentiment" section in your JSON response if x_sentiment data is present in the payload.
Structure:
"x_sentiment": {
"btc_sentiment": {"overall": "bullish/bearish/neutral", "score": X.X, "key_narrative": "..."},
"market_mood": "risk-on/risk-off/mixed",
"top_social_movers": [{"symbol": "...", "social_velocity": "exploding/surging/rising", "sentiment": "bullish/bearish/mixed", "why_trending": "...", "catalyst": "..."}],
"narrative_heat": [{"narrative": "...", "buzz_level": "hot/warm/cold", "direction": "bullish/bearish", "top_tokens": [...]}],
"summary": "2-3 sentence X sentiment overview"
}
If x_sentiment data is empty or unavailable in the payload, omit this section entirely.
X SENTIMENT INFLUENCE ON MOMENTUM PICKS:
When a coin appears in BOTH x_sentiment.trending_tickers AND in perps data (squeezes, divergences), it gets ELEVATED conviction:

Coin in squeeze candidates + exploding X social velocity = HIGH conviction
Coin in funding divergence + surging X mentions = HIGH conviction
Coin with high social velocity but NO perps confirmation = MEDIUM at best (could be pump & dump)
Add a note in the thesis when X sentiment confirms or contradicts the technical/funding setup.


### Fix 3: Reorder sections — X Sentiment above Momentum Picks

Update the section ordering instruction in Claude's crypto preamble:
RESPONSE SECTION ORDER (follow this exactly):

market_overview (top-level sentiment summary)
btc_eth_summary (BTC and ETH with dominance, funding)
hot_categories (narrative rotation)
Futures & Perps section (perps_overview, perps_squeezes, perps_crowded_longs, perps_divergences, perps_top_volume)
x_sentiment (X/Twitter social sentiment — ABOVE momentum picks so the social signals inform the picks below)
top_momentum (final conviction picks — informed by ALL data above including X sentiment)
attention_signals, volume_acceleration, upcoming_catalysts, portfolio_bias


### Testing
1. Click "Crypto" → check logs for:
   - `[CRYPTO_SCANNER] X sentiment: X trending tickers` (confirms Grok returned data)
   - `[CRYPTO_COMPRESS] X sentiment preserved: X tickers` (confirms compression kept it)
2. Response should show X Sentiment section ABOVE Top Momentum Picks
3. Top Momentum Picks for OM should show funding_rate: -0.29% (not "-")
4. Top Momentum Picks for AXS should show funding_rate: -0.18% (not "-")  
5. If a coin appears in both X trending AND squeeze candidates, its conviction should be elevated
6. BTC sentiment should appear in X section
7. All other sections still render correctly
8. `python -m pytest` passes