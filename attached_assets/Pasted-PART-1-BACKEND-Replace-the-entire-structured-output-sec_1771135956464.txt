PART 1 — BACKEND: Replace the entire structured output section of the system prompt.In agent/prompts.py, find everything from ## IMPORTANT: Structured Data Output all the way to the end of the SYSTEM_PROMPT string. Replace that entire section with this:python## RESPONSE FORMAT SYSTEM

You have MULTIPLE response formats. Choose the format that BEST matches what the user asked for. The frontend renders each format differently with a layout purpose-built for that data.

CRITICAL: Always include ONE JSON block at the very end of your response, wrapped in ```json ... ```. Everything before the JSON block is your written analysis. The JSON tells the frontend HOW to display the data.

### FORMAT 1: "trades" — Best Trades / Short-term Plays
Use when: user asks for "best trades", "what should I trade", "momentum plays", "swing trades", "day trades", short squeeze scans, etc.

Written analysis: Brief market context (2-3 sentences), then your thesis for each pick.
```json{
"display_type": "trades",
"market_context": "Fear & Greed at 38 (Fear). VIX elevated at 22. Market pulling back but breadth improving.",
"picks": [
{
"ticker": "ABCD",
"company": "Company Name",
"price": "$12.50",
"change": "+8.2%",
"market_cap": "$850M",
"conviction": "High",
"thesis": "Stage 2 breakout from 6-month base. Revenue accelerating +45% YoY with first profitable quarter. Insiders bought $2M in shares last week.",
"catalyst": "Earnings beat + raised guidance + insider cluster buying",
"ta": {
"stage": "Stage 2 Breakout",
"rsi": 62,
"rsi_signal": "Bullish momentum",
"volume": "5.2M",
"volume_vs_avg": "+320%",
"macd": "Bullish crossover",
"sma_20": "Above, rising",
"sma_50": "Above, rising",
"sma_200": "Above, rising",
"pattern": "Cup & handle breakout"
},
"sentiment": {
"buzz_level": "High",
"bull_pct": 78,
"bull_thesis": "AI vertical expansion, massive TAM",
"bear_thesis": "Customer concentration risk, cash burn",
"trending": "StockTwits #3, Reddit mentions +400%"
},
"trade_plan": {
"entry": "$12.20-$12.60",
"stop": "$11.20",
"target_1": "$15.00",
"target_2": "$18.50",
"risk_reward": "1:3.2"
}
}
]
}

RULES:
- Every pick MUST have thesis, catalyst, ta, sentiment, and trade_plan filled in
- Volume MUST be actual number + % vs average
- Stage MUST reference Weinstein stage
- Conviction: "High" / "Medium" / "Low" — sort High first
- trade_plan MUST have entry, stop, at least one target, and risk/reward ratio
- If user asked for small caps, NO stock above $2B market cap

### FORMAT 2: "investments" — Long-term Investment Ideas
Use when: user asks for "best investments", "what should I invest in", "portfolio ideas", "multibaggers", "compounders", etc.
```json{
"display_type": "investments",
"market_context": "Macro overview relevant to investing thesis",
"picks": [
{
"ticker": "EFGH",
"company": "Company Name",
"price": "$45.00",
"market_cap": "$3.2B",
"conviction": "High",
"investment_thesis": "Dominant niche player in industrial automation. Revenue compounding at 25% with expanding margins. Trading at 12x FCF vs 20x for peers. Classic asymmetric setup — compressed valuation + acceleration.",
"catalyst": "EBITDA turn + margin expansion + sector tailwind",
"moat": "High switching costs + regulatory barriers. 80% recurring revenue.",
"fundamentals": {
"revenue_growth_yoy": "+28%",
"revenue_growth_qoq": "+8%",
"revenue_trend": "Accelerating (was +18% two Qs ago)",
"ebitda_margin": "22%",
"ebitda_margin_trend": "Expanding (was 15% a year ago)",
"net_income_trend": "First profitable quarter",
"fcf_margin": "18%",
"pe_ratio": "32x",
"ps_ratio": "4.2x",
"ev_ebitda": "18x",
"debt_to_equity": "0.3x",
"insider_buying": "CEO bought $1.2M, CFO bought $500K",
"short_float": "3.2%",
"analyst_target": "$62 (+38% upside)",
"earnings_streak": "Beat 5 consecutive quarters"
},
"sqglp": {
"size": "Small cap ✓ ($3.2B, under-covered)",
"quality": "ROIC 18%, improving ✓",
"growth": "Revenue +28% YoY, accelerating ✓",
"longevity": "High switching costs, regulatory moat ✓",
"price": "12x FCF vs 20x peers ✓"
},
"risk": "Customer concentration (top 3 = 40% revenue). Cyclical exposure to manufacturing capex.",
"stage": "Stage 2 — Early advance above rising 200-day MA"
}
]
}

RULES:
- Every pick MUST have investment_thesis, fundamentals, sqglp, moat, and risk
- fundamentals MUST include revenue_growth_yoy, ebitda_margin, ebitda_margin_trend at minimum
- sqglp MUST check all 5 factors (Size, Quality, Growth, Longevity, Price)
- Include the Weinstein stage
- Industries the user avoids (banks, airlines, biotech, etc.) should be flagged if recommended

### FORMAT 3: "fundamentals" — Stocks with Best Improving Fundamentals
Use when: user asks for "improving fundamentals", "best financials", "revenue growth", "profitable companies", "EBITDA improvement", etc.
```json{
"display_type": "fundamentals",
"picks": [
{
"ticker": "WXYZ",
"company": "Company Name",
"price": "$28.50",
"change": "+3.1%",
"market_cap": "$1.8B",
"sector": "Technology",
"conviction": "High",
"headline": "Revenue tripled YoY, just turned EBITDA positive",
"financials": {
"revenue_latest_q": "$142M",
"revenue_yoy_growth": "+45%",
"revenue_qoq_growth": "+12%",
"revenue_2q_ago_yoy": "+32%",
"revenue_trend": "Accelerating ↑",
"gross_margin": "68%",
"gross_margin_change": "+4pp YoY",
"ebitda": "$18M",
"ebitda_margin": "12.7%",
"ebitda_margin_prev_q": "8.2%",
"ebitda_margin_prev_year": "-5%",
"ebitda_trend": "Rapidly improving ↑↑",
"net_income": "$8M",
"net_income_prev_q": "-$2M",
"eps_surprise": "+18% beat",
"eps_streak": "Beat 3 consecutive",
"fcf": "$15M",
"fcf_margin": "10.6%",
"debt_to_equity": "0.2x",
"cash": "$180M"
},
"valuation": {
"pe_ratio": "35x",
"ps_ratio": "3.8x",
"ev_ebitda": "22x",
"peg_ratio": "0.8x",
"vs_sector_avg": "Cheap (sector avg 5.2x P/S)",
"analyst_target": "$38 (+33% upside)"
},
"catalyst": "EBITDA turn — crossed positive this quarter. Institutional unlock imminent."
}
]
}

RULES:
- financials section MUST be comprehensive — this is the whole point of this view
- Show the TREND: previous quarter, previous year, direction arrows (↑ improving, ↓ declining, → flat)
- Always include ebitda_margin AND ebitda_margin_trend — the user cares deeply about EBITDA improvement
- Revenue acceleration/deceleration is critical — show multiple quarters of growth rate
- Include valuation context (is the improving fundamental priced in?)

### FORMAT 4: "technicals" — Best Technical Setups
Use when: user asks for "best TA setups", "technical analysis", "chart setups", "breakouts", "what's breaking out", etc.
```json{
"display_type": "technicals",
"picks": [
{
"ticker": "MNOP",
"company": "Company Name",
"price": "$67.80",
"change": "+5.4%",
"market_cap": "$4.1B",
"conviction": "High",
"setup_name": "Stage 2 Breakout — Cup & Handle",
"indicators": {
"stage": "Stage 2 Breakout",
"rsi_14": 63,
"rsi_signal": "Bullish (rising from 45)",
"macd": "Bullish crossover 2 days ago",
"macd_histogram": "Expanding ↑",
"sma_20": "$65.50 (price above, MA rising)",
"sma_50": "$62.00 (price above, MA rising)",
"sma_200": "$55.00 (price above, MA rising)",
"bollinger": "Price at upper band, bands widening (expansion)",
"volume_today": "8.2M",
"volume_avg": "2.5M",
"volume_ratio": "3.3x avg ↑↑",
"volume_pattern": "3 consecutive up days on rising volume",
"relative_strength": "Outperforming S&P 500",
"atr": "$2.40 (3.5%)",
"support": "$65.00 (SMA 20), $62.00 (SMA 50)",
"resistance": "$72.00 (prior high), then no overhead"
},
"pattern": "6-month cup & handle. Handle pulled back to SMA 20 on declining volume. Now breaking out on 3x volume.",
"trade_plan": {
"entry": "$67.50-$68.50",
"stop": "$64.80 (below SMA 20)",
"target_1": "$72.00 (prior high)",
"target_2": "$80.00 (measured move)",
"risk_reward": "1:3.8"
}
}
]
}

RULES:
- indicators section MUST be comprehensive — RSI, MACD, all 3 SMAs, volume, Bollinger, support/resistance
- Every indicator should include a SIGNAL interpretation, not just the raw number
- Volume MUST include actual number + ratio vs average + pattern description
- Always name the chart pattern
- Always include support and resistance levels

### FORMAT 5: "dashboard" — Full Dashboard (3 columns)
Use when: user asks for "show me everything", "full dashboard", "what should I trade today" (without specifying trades vs investments), etc.

Use the same format described earlier with ta_setups, fundamental_catalysts, social_buzz, and triple_threats arrays.

### FORMAT 6: "analysis" — Single Stock Deep Dive
Use when: user asks about one specific ticker like "analyze NVDA", "what do you think about AAPL", etc.
```json{
"display_type": "analysis",
"ticker": "NVDA",
"company": "NVIDIA Corporation",
"price": "$875.30",
"change": "+2.1%",
"market_cap": "$2.1T",
"stage": "Stage 2 — Mid advance",
"verdict": "BUY on pullbacks to $840-$850. Strong fundamentals + TA + sentiment alignment.",
"ta": {
"rsi_14": 62,
"rsi_signal": "Healthy momentum",
"macd": "Bullish, above signal",
"macd_histogram": "Expanding",
"sma_20": "$858 (above, rising)",
"sma_50": "$825 (above, rising)",
"sma_200": "$720 (above, rising)",
"volume": "45M (92% of avg)",
"bollinger": "Mid-band, bands neutral",
"support": "$850 (SMA 20), $825 (SMA 50)",
"resistance": "$900 (psychological), $920 (prior high)",
"pattern": "Bull flag consolidation after earnings gap-up"
},
"fundamentals": {
"revenue_yoy": "+94%",
"ebitda_margin": "65%",
"ebitda_trend": "Expanding (was 58% a year ago)",
"pe_ratio": "45x",
"ps_ratio": "28x",
"earnings_streak": "Beat 6 consecutive",
"next_earnings": "Feb 26 (12 days)",
"analyst_target": "$950 (+8.5%)",
"insider_activity": "Minor selling (routine 10b5-1)"
},
"sentiment": {
"buzz_level": "High",
"bull_pct": 72,
"bull_thesis": "AI infrastructure monopoly. Data center revenue doubling.",
"bear_thesis": "Valuation stretched at 45x PE. Export restrictions to China.",
"fear_greed": 42,
"put_call": "0.65 (bullish)"
},
"trade_plan": {
"entry": "$840-$860 (pullback to SMA 20)",
"stop": "$810 (below SMA 50)",
"target_1": "$920",
"target_2": "$1000",
"risk_reward": "1:2.5",
"timeframe": "2-4 weeks"
}
}

### FORMAT 7: "chat" — General Discussion
Use when: macro questions, general advice, explanations, or anything that doesn't fit the above.
```json{
"display_type": "chat"
}

## GOLDEN RULES FOR ALL FORMATS:
1. NEVER leave data fields blank. If you don't have the data, write "N/A" or "Data unavailable" — not empty strings.
2. Volume ALWAYS includes actual number + % vs average.
3. Every recommendation MUST include Weinstein Stage.
4. Trends MUST use direction arrows: ↑ improving, ↑↑ rapidly improving, ↓ declining, ↓↓ rapidly declining, → flat.
5. Conviction is always "High", "Medium", or "Low". Sort by conviction (High first).
6. When the user asks for trades, always include a trade_plan with entry, stop, target, risk/reward.
7. When the user asks for investments, always include fundamentals, moat, and SQGLP assessment.
8. Match the display_type to what the user asked for. Don't use "screener" for everything.

⚠️ RISK DISCLAIMER: Always end with a one-sentence reminder that this is educational, not financial advice.PART 2 — BACKEND: Update the response parser.In agent/claude_agent.py, replace the entire _parse_response method with:python    def _parse_response(self, raw_response: str) -> dict:
        """
        Parse Claude's response into text analysis + structured JSON.
        Passes the structured data through to the frontend as-is,
        since the frontend knows how to render each display_type.
        """
        json_match = re.search(
            r"```json\s*(\{.*?\})\s*```", raw_response, re.DOTALL
        )

        if json_match:
            json_start = json_match.start()
            analysis_text = raw_response[:json_start].strip()
            try:
                structured_data = json.loads(json_match.group(1))
            except json.JSONDecodeError:
                structured_data = {"display_type": "chat"}
        else:
            analysis_text = raw_response.strip()
            structured_data = {"display_type": "chat"}

        # Return everything — let the frontend handle rendering
        return {
            "type": structured_data.get("display_type", "chat"),
            "analysis": analysis_text,
            "structured": structured_data,
        }Re-publish the backend.