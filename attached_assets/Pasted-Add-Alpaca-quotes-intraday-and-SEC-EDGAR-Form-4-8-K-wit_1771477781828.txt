Add Alpaca (quotes + intraday) and SEC EDGAR (Form 4 + 8-K) without changing response schemas or frontend contract

Goal:

Fix blank price and chg% by using Alpaca as the primary quote + intraday provider.

Add SEC EDGAR validation for insider and catalysts (Form 4 and 8-K).

Do NOT change existing response schemas, display_type, or payload contract.

Do NOT increase rate-limit risk. Use caching and call budgets.

A) Alpaca Market Data Provider (quotes + intraday)

Add new file: data/alpaca_provider.py
Implement:

get_quote(symbol) -> { price, change, change_percent, bid, ask, as_of_utc }

get_latest_trade(symbol) -> { price, as_of_utc } (fallback if quote missing)

get_intraday_bars(symbol, timeframe="1Min", limit=390) -> list[bars] (optional but recommended for intraday screens)
Use Alpaca Data API endpoints with headers:

APCA-API-KEY-ID

APCA-API-SECRET-KEY

Add strict timeout and retries:

timeout 6-8s per request

retry 1x on 429/5xx with short backoff

Add caching:

Quote cache TTL: 15-30 seconds (so UI feels live but avoids hammering)

Intraday bars cache TTL: 60 seconds

Add circuit breaker:

If Alpaca auth fails (401/403) disable Alpaca provider for 30 minutes and fall back to existing providers.

Track in logs and in the new candle_stats endpoint if it exists.

B) Wire Alpaca into the existing data flow (without changing schemas)

In market_data_service.py (or your current service that builds quote snapshots):

Initialize self.alpaca = AlpacaProvider(...) in __init__.

Create a centralized method: get_live_quote(symbol) that tries providers in this order:

Alpaca quote

Finnhub quote (existing)

FMP quote (if you have it)

Ensure return keys match your internal normalized quote model so existing downstream formatting works.

Replace the current quote fetch used by:

macro snapshot builder (_build_macro_snapshot)

screener enrichment table (price, chg%, market cap display if derived)

best_trades output (current price, change, and intraday context)
Use get_live_quote() everywhere instead of calling Finnhub directly.

Add log line once per request (not per ticker spam):

[QUOTES] alpaca_ok=<n> finnhub_ok=<n> fmp_ok=<n> cache_hits=<n> failed=<n>

Add a per-request QuoteBudget:

max_quote_calls = 25 per request

if exceeded, stop fetching quotes and leave remaining as null, do not return "N/A" strings

C) SEC EDGAR Provider (Form 4 + 8-K)

Add new file: data/sec_edgar_provider.py
Requirements:

Use SEC’s free endpoints (no key).

Set a required User-Agent header: User-Agent: HippoAI (<your email>) and Accept-Encoding gzip.
Implement:

get_cik_for_ticker(ticker) -> cik using SEC’s company tickers mapping JSON, cached 30 days

get_recent_filings(cik) -> list using submissions endpoint, cached 6 hours

get_recent_form4(cik, lookback_days=30) -> { has_recent_form4, form4_count, latest_date }

get_recent_8k(cik, lookback_days=14) -> { has_recent_8k, item_count_estimate, latest_date }
Notes:

Do not scrape HTML pages.

Use JSON endpoints and keep payload small.

Add caching and call budgeting:

CIK map cache: 30 days

submissions cache: 6 hours per CIK

Budget: max 6 EDGAR requests per user request

For screeners, only validate EDGAR for the top 10 ranked tickers to avoid extra calls.

Add normalization:

Return nulls when unavailable.

Never emit "N/A" strings in structured payloads.

D) Use EDGAR in the right places

Insider+Breakout screener:

Replace any “insider” claim that is not backed by real data.

Insider signal must come from:

Form 4 within 30 days = insider_present true

Otherwise insider_present false

Add to each row (internal only, do not change schema): insider.form4_recent, insider.form4_latest_date, catalyst.recent_8k, catalyst.latest_8k_date.

Best Trades:

Add a “Catalyst check” step:

If a ticker is recommended, and EDGAR shows a recent 8-K or Form 4, mark catalyst_present true and reference it.

If no EDGAR signal, do not invent a catalyst.

Cross-asset trending:

For equities surfaced by Grok/social, do EDGAR validation only for the top 5 equities.

If EDGAR confirms an 8-K or Form 4, it should boost “real catalyst” confidence.

If EDGAR finds nothing, keep it neutral.

E) Do not break existing contracts

Do NOT change the response envelope shape.

Do NOT change display_type values.

Do NOT add required fields to the frontend contract.

Add new fields only inside existing structured objects if that’s already how you enrich data, and keep them optional.

F) Tests + debug

Add unit tests for:

Alpaca quote parsing and fallback behavior

EDGAR CIK resolution caching

EDGAR recent Form 4 and 8-K detection logic

Add one debug endpoint:

GET /api/provider_stats returning per-provider counts and circuit breaker state for alpaca and sec edgar (do not include secrets)

G) Acceptance tests to run

Screener table shows price and chg% populated for at least 80% of rows.

Insider+Breakout shows “insider present” only when Form 4 exists.

Best Trades includes TA breakdown and does NOT claim “insider buying” unless Form 4 exists.

Server runs clean. Publish when done.