## Fix: Portfolio Review returns 502 + upgrade to full AI portfolio adviser

### Problem
Clicking "AI Portfolio Review" returns "Failed to get portfolio review. Please try again. (Status 502)". The portfolio review endpoint at `/api/portfolio/review` in `main.py` (line 1641) has several issues:

1. **502 error** — likely timeout from serial data fetching or Claude API call. The current code fetches data one ticker at a time with 0.3s delays.
2. **Missing critical data** — No live quotes/prices, no candles/TA, no Grok social sentiment, no macro context, no regime data. Only pulls StockAnalysis overview + StockTwits + FMP news.
3. **No portfolio-aware analysis** — Doesn't pass current prices, P&L, position sizes, or correlation context to Claude.

### Fix: Rewrite the portfolio review endpoint

Replace the entire `/api/portfolio/review` handler (lines 1641-1810) with a proper implementation:
```python
@app.post("/api/portfolio/review")
@limiter.limit("5/minute")
async def review_portfolio(request: Request, api_key: str = Header(None, alias="X-API-Key")):
    """AI Portfolio Review — comprehensive analysis with Buy/Hold/Sell verdicts."""
    import asyncio
    import time as _time

    if not api_key or api_key != AGENT_API_KEY:
        raise HTTPException(status_code=403, detail="Invalid or missing API key.")

    await _wait_for_init()
    body = await request.json()
    start = _time.time()
    
    print(f"[PORTFOLIO_REVIEW] === ENDPOINT HIT ===")
    holdings = body.get("holdings", [])
    print(f"[PORTFOLIO_REVIEW] Holdings: {[h.get('ticker') for h in holdings]}")

    if not holdings:
        return {
            "type": "chat",
            "analysis": "",
            "structured": {
                "display_type": "chat",
                "message": "No holdings to review. Add some positions to your portfolio first.",
            },
        }

    tickers = [h.get("ticker", "").upper().strip() for h in holdings if h.get("ticker")]
    
    # Build holdings context with cost basis
    holdings_context = []
    for h in holdings:
        ticker = h.get("ticker", "").upper().strip()
        shares = float(h.get("shares", 0) or 0)
        avg_cost = float(h.get("avg_cost", 0) or h.get("avgCost", 0) or 0)
        asset_type = h.get("type", h.get("asset_type", "stock")).lower()
        holdings_context.append({
            "ticker": ticker,
            "shares": shares,
            "avg_cost": avg_cost,
            "cost_basis": round(shares * avg_cost, 2),
            "asset_type": asset_type,
        })

    # === PHASE 1: Parallel data gathering (all at once, not serial) ===
    
    async def fetch_ticker_data(ticker, asset_type="stock"):
        """Fetch all data for one ticker in parallel."""
        result = {"ticker": ticker, "asset_type": asset_type}
        
        tasks = {}
        
        # Overview / fundamentals
        tasks["overview"] = asyncio.wait_for(
            agent.data.stockanalysis.get_overview(ticker),
            timeout=6.0,
        )
        
        # Live quote
        tasks["quote"] = asyncio.wait_for(
            asyncio.to_thread(agent.data.finnhub.get_quote, ticker),
            timeout=5.0,
        )
        
        # Social sentiment
        tasks["sentiment"] = asyncio.wait_for(
            agent.data.stocktwits.get_sentiment(ticker),
            timeout=5.0,
        )
        
        # Candles for TA (120 days)
        tasks["candles"] = asyncio.wait_for(
            agent.data.get_candles(ticker, days=120),
            timeout=8.0,
        )
        
        # Analyst ratings
        tasks["analyst"] = asyncio.wait_for(
            agent.data.stockanalysis.get_analyst_ratings(ticker),
            timeout=5.0,
        )
        
        # News
        if agent.data.fmp:
            tasks["news"] = asyncio.wait_for(
                agent.data.fmp.get_stock_news(ticker, limit=3),
                timeout=5.0,
            )
        
        # Execute all in parallel
        task_keys = list(tasks.keys())
        task_coros = list(tasks.values())
        results = await asyncio.gather(*task_coros, return_exceptions=True)
        
        for key, res in zip(task_keys, results):
            if isinstance(res, Exception):
                print(f"[PORTFOLIO_REVIEW] {ticker}/{key} failed: {res}")
                continue
            if res:
                if key == "overview":
                    result["overview"] = res
                elif key == "quote":
                    if isinstance(res, dict) and res.get("price"):
                        result["current_price"] = res["price"]
                        result["change_pct"] = res.get("change_pct")
                elif key == "sentiment":
                    result["social_sentiment"] = res
                elif key == "candles":
                    if isinstance(res, list) and len(res) >= 20:
                        from data.ta_utils import compute_technicals_from_bars
                        result["technicals"] = compute_technicals_from_bars(res)
                        result["current_price"] = result.get("current_price") or res[-1].get("c")
                elif key == "analyst":
                    result["analyst_ratings"] = res
                elif key == "news":
                    result["recent_news"] = res[:3] if isinstance(res, list) else res
        
        return result
    
    # Fetch all tickers in parallel (not serial!)
    ticker_tasks = [fetch_ticker_data(t) for t in tickers[:15]]
    ticker_results = await asyncio.gather(*ticker_tasks, return_exceptions=True)
    
    ticker_data = {}
    for res in ticker_results:
        if isinstance(res, Exception):
            print(f"[PORTFOLIO_REVIEW] Ticker fetch exception: {res}")
            continue
        if isinstance(res, dict) and res.get("ticker"):
            ticker_data[res["ticker"]] = res
    
    print(f"[PORTFOLIO_REVIEW] Data gathered for {len(ticker_data)}/{len(tickers)} tickers ({_time.time()-start:.1f}s)")
    
    # === PHASE 2: Grok social scan (if available) ===
    grok_sentiment = {}
    if agent.data.xai and tickers:
        try:
            grok_sentiment = await asyncio.wait_for(
                agent.data.xai.get_batch_sentiment(tickers[:5]),
                timeout=20.0,
            )
            print(f"[PORTFOLIO_REVIEW] Grok sentiment: {len(grok_sentiment)} tickers")
        except Exception as e:
            print(f"[PORTFOLIO_REVIEW] Grok sentiment failed: {e}")
    
    # Merge Grok data
    for ticker, grok_data in grok_sentiment.items():
        if ticker in ticker_data and "error" not in grok_data:
            ticker_data[ticker]["x_sentiment"] = grok_data
    
    # === PHASE 3: Macro context ===
    macro_snapshot = {}
    try:
        macro_snapshot = await asyncio.wait_for(
            agent.data._build_macro_snapshot(),
            timeout=8.0,
        )
    except Exception as e:
        print(f"[PORTFOLIO_REVIEW] Macro snapshot failed: {e}")
    
    # === PHASE 4: Build portfolio-aware context for Claude ===
    total_cost_basis = sum(h["cost_basis"] for h in holdings_context)
    
    portfolio_summary = {
        "total_holdings": len(holdings_context),
        "total_cost_basis": total_cost_basis,
        "holdings": [],
    }
    
    for h in holdings_context:
        ticker = h["ticker"]
        td = ticker_data.get(ticker, {})
        current_price = td.get("current_price")
        
        position = {
            "ticker": ticker,
            "shares": h["shares"],
            "avg_cost": h["avg_cost"],
            "cost_basis": h["cost_basis"],
            "weight_pct": round(h["cost_basis"] / total_cost_basis * 100, 1) if total_cost_basis else 0,
        }
        
        if current_price:
            position["current_price"] = current_price
            position["market_value"] = round(h["shares"] * current_price, 2)
            position["unrealized_pnl"] = round((current_price - h["avg_cost"]) * h["shares"], 2)
            position["unrealized_pnl_pct"] = round((current_price - h["avg_cost"]) / h["avg_cost"] * 100, 1) if h["avg_cost"] else 0
            position["change_today_pct"] = td.get("change_pct")
        
        # Add fundamental summary
        overview = td.get("overview", {})
        if isinstance(overview, dict):
            for key in ["pe_ratio", "ps_ratio", "market_cap", "revenue_growth", "eps_growth",
                        "profit_margin", "sector", "industry", "beta", "52_week_high", "52_week_low",
                        "dividend_yield", "analyst_rating", "price_target"]:
                val = overview.get(key)
                if val is not None:
                    position[key] = val
        
        # Add TA summary
        technicals = td.get("technicals", {})
        if technicals:
            position["ta"] = {
                "rsi": technicals.get("rsi") or technicals.get("rsi_14"),
                "sma_20": technicals.get("sma_20"),
                "sma_50": technicals.get("sma_50"),
                "sma_200": technicals.get("sma_200"),
                "macd_signal": technicals.get("macd_signal"),
            }
        
        # Add sentiment summary
        social = td.get("social_sentiment", {})
        if social and isinstance(social, dict):
            position["sentiment"] = social.get("sentiment", "unknown")
            position["sentiment_score"] = social.get("bullish_pct")
        
        x_sent = td.get("x_sentiment", {})
        if x_sent and isinstance(x_sent, dict):
            position["x_sentiment"] = x_sent.get("overall_sentiment")
            position["x_summary"] = x_sent.get("summary")
        
        # Add analyst summary
        analyst = td.get("analyst_ratings", {})
        if analyst and isinstance(analyst, dict):
            position["analyst_consensus"] = analyst.get("consensus") or analyst.get("rating")
            position["analyst_target"] = analyst.get("price_target") or analyst.get("target_price")
        
        # Add recent news headlines
        news = td.get("recent_news", [])
        if news and isinstance(news, list):
            position["news_headlines"] = [
                n.get("title", n.get("headline", "")) for n in news[:3] if isinstance(n, dict)
            ]
        
        portfolio_summary["holdings"].append(position)
    
    # Calculate total portfolio market value
    total_market_value = sum(
        p.get("market_value", p.get("cost_basis", 0)) 
        for p in portfolio_summary["holdings"]
    )
    portfolio_summary["total_market_value"] = total_market_value
    portfolio_summary["total_unrealized_pnl"] = round(total_market_value - total_cost_basis, 2)
    portfolio_summary["total_return_pct"] = round(
        (total_market_value - total_cost_basis) / total_cost_basis * 100, 1
    ) if total_cost_basis else 0
    
    # Compute concentration metrics
    weights = [p.get("weight_pct", 0) for p in portfolio_summary["holdings"]]
    portfolio_summary["max_weight"] = max(weights) if weights else 0
    portfolio_summary["hhi"] = round(sum(w**2 for w in weights), 1)  # Herfindahl index
    
    # Add macro
    if macro_snapshot:
        portfolio_summary["macro_context"] = {
            "fear_greed": macro_snapshot.get("fear_greed"),
            "vix": macro_snapshot.get("vix"),
            "treasury_10y": macro_snapshot.get("treasury_rates", {}).get("10y"),
            "regime": macro_snapshot.get("regime"),
        }

    print(f"[PORTFOLIO_REVIEW] Portfolio context built ({_time.time()-start:.1f}s)")

    # === PHASE 5: Claude analysis ===
    from agent.data_compressor import compress_data
    compressed = compress_data(portfolio_summary)
    data_str = _json.dumps(compressed, default=str)
    
    print(f"[PORTFOLIO_REVIEW] Sending {len(data_str):,} chars to Claude")

    from agent.prompts import SYSTEM_PROMPT
    messages = [{
        "role": "user",
        "content": f"""[PORTFOLIO REVIEW REQUEST]

{data_str}

You are reviewing my personal investment portfolio. This is my real money. Be direct and honest.

For EACH position, provide:

1. **VERDICT**: BUY MORE / HOLD / TRIM / SELL — pick one, be decisive
2. **THESIS** (2-3 sentences): Why this verdict? Reference the specific data — current price vs avg cost, P&L, fundamentals (revenue growth, margins, PE), technical setup (RSI, SMA position, MACD), social sentiment, and recent news.
3. **KEY RISK**: The single biggest risk to this position right now
4. **CATALYST**: Next potential catalyst that could move the price (earnings, product launch, macro event, sector rotation)
5. **TIMEFRAME**: How long to hold before re-evaluating (days, weeks, months, quarters)
6. **POSITION SIZE**: Is my current allocation appropriate? Should I increase/decrease weight?

Then provide OVERALL PORTFOLIO ASSESSMENT:
- Portfolio grade (A through F) with justification
- Sector/theme exposure — am I too concentrated or well-diversified?
- Correlation risk — if one position drops, what happens to others?
- Macro alignment — does my portfolio fit the current regime (Fear & Greed, rates, VIX)?
- REBALANCING RECOMMENDATION: Specific percentage allocations I should target
- TOP ACTION ITEMS: The 1-3 most important things I should do this week
- If you had to add ONE new position to improve this portfolio, what would it be and why? Give a specific ticker with thesis.

Be my portfolio advisor. No generic disclaimers in the body. One brief disclaimer at the very bottom.

IMPORTANT: Respond with display_type "chat" and put your full analysis in the "message" field as formatted text.""",
    }]

    try:
        response = await asyncio.wait_for(
            asyncio.to_thread(
                agent.client.messages.create,
                model="claude-sonnet-4-20250514",
                max_tokens=4096,
                system=SYSTEM_PROMPT,
                messages=messages,
            ),
            timeout=60.0,
        )

        response_text = response.content[0].text.strip()
        print(f"[PORTFOLIO_REVIEW] Claude responded: {len(response_text)} chars ({_time.time()-start:.1f}s total)")

        try:
            if response_text.startswith("```"):
                response_text = response_text.split("\n", 1)[1].rsplit("```", 1)[0].strip()
            parsed = _json.loads(response_text)
            if "structured" in parsed:
                return parsed
            return {
                "type": "chat",
                "analysis": parsed.get("message", response_text),
                "structured": parsed,
            }
        except _json.JSONDecodeError:
            return {
                "type": "chat",
                "analysis": response_text,
                "structured": {
                    "display_type": "chat",
                    "message": response_text,
                },
            }

    except asyncio.TimeoutError:
        print(f"[PORTFOLIO_REVIEW] Claude timed out after 60s")
        return {
            "type": "chat",
            "analysis": "",
            "structured": {
                "display_type": "chat",
                "message": "Portfolio review timed out. Please try again.",
            },
        }
    except Exception as e:
        print(f"[PORTFOLIO_REVIEW] Error: {e}")
        import traceback
        traceback.print_exc()
        return {
            "type": "chat",
            "analysis": "",
            "structured": {
                "display_type": "chat",
                "message": f"Error reviewing portfolio: {str(e)}",
            },
        }
```

### Key improvements over the old version:

1. **Parallel data fetching** — All tickers fetch simultaneously, not serially. For 2 holdings, this takes ~6s instead of ~15s.
2. **Full data stack per ticker** — Quote (live price), candles (TA), StockAnalysis (fundamentals), analyst ratings, StockTwits sentiment, Grok X sentiment, FMP news
3. **Portfolio-aware context** — P&L per position, unrealized gains/losses, position weights, concentration metrics (HHI), total portfolio return
4. **Macro context** — Fear & Greed, VIX, treasury rates, regime
5. **Better Claude prompt** — Asks for timeframe, position sizing, rebalancing percentages, correlation analysis, regime alignment

### Testing

1. **Click "AI Portfolio Review"** — Should return a detailed review of ATOM and NVDA with:
   - Current prices (not N/A)
   - P&L calculation (shares × (current_price - avg_cost))
   - TA data (RSI, SMA position)
   - Fundamental data (PE, revenue growth if applicable)
   - Social sentiment from StockTwits and Grok
   - Macro context (Fear & Greed, VIX)
   - Clear BUY MORE / HOLD / TRIM / SELL verdict per position
   - Rebalancing recommendation
   
2. **Check logs** for:
   - `[PORTFOLIO_REVIEW] Data gathered for 2/2 tickers`
   - `[PORTFOLIO_REVIEW] Grok sentiment: 2 tickers`
   - `[PORTFOLIO_REVIEW] Claude responded: XXXX chars`
   - No tracebacks

3. **Run `python -m pytest`** — All tests pass

4. **Regression**: All other presets (Trending Now, Best Trades, Best Investments, screeners) still work